---
date: 2017-04-26T15:05:07-08:00
draft: false
title: "AWSLambdaFace: serverless face recognition"

description: "TL;DR: Serverless compute platforms such as Amazon Web Services
(AWS) Lambda were intended to be used for web microservices and to handle
asynchronous events generated by other Amazon web services (DynamoDB, S3, SNS,
etc.). However, AWS Lambda also allows users to upload arbitrary linux binaries
along with their lambda functions. These binaries can be executed during a
lambda invocation, effectively turning AWS Lambda into a supercomputer that can
be started on-demand in seconds and billed at a 100ms granularity. In this post,
I will show you how I deployed a full-blown deep convolutional neural network
based face recognition tool on AWS Lambda and used the system to query for faces
in videos in a massively parallel way (skip to figure 2 to see the end
result!)."
---

<div style="width:100%;margin-bottom:10px;">
  <div style="margin: 0 auto;border:solid;border-width:2px;border-color:rgb(200,200,200);text-align:center;min-width:300px;max-width:100%;width:600px;border-radius:10px;">
    <a href="/images/awslambdaface/blog_john_emmons_ec2_console.png">
      <img src="/images/awslambdaface/blog_john_emmons_ec2_console.png" alt="ec2_console" style="width:100%;border-radius:7px;" >
    </a>
    <p style="padding:10px;padding-bottom:0px;text-align:left">
      Figure 1: with function as a service (FaaS) platforms like AWS Lambda,
      going completely <span style="font-style:italic">serverless</span> has
      become a viable option for web technology companies. Rather than buying
      physical machines or provisioning EC2 VMs, companies such
      as <a href="https://acloud.guru/">A Cloud
      Guru</a>, <a href="https://instant.cm/">Instant</a>,
      and <a href="https://serverless.com/">Serverless</a> rely entirely on
      auto-scaling, fully-managed services like DynamoDB, Lambda, SNS, SQS, etc.
      (an empty EC2 dashboard has become a badge of honor!).
    </p>
  </div>
</div>

<p>
  In 2014, Amazon Web Services (AWS) released their function as a service (FaaS)
  platform, Lambda. Since then, a burgeoning community of developers has formed
  around this technology, generating countless web frameworks,
  debugging/monitoring tools, and storage backends specifically designed for
  the <span style="font-style:italic">serverless</span> world. The capabilities
  of this technology is best understood by examining the EC2 dashboard of start
  ups such as <a href="https://acloud.guru/">A Cloud
  Guru</a>, <a href="https://instant.cm/">Instant</a>,
  and <a href="https://serverless.com/">Serverless</a> (figure 1); these
  companies have been built using nothing but serverless technologies like
  Lamdba and DynamoDB. The FaaS paradigm has even worked its way into many major
  businesses outside of the tech industry; for example, Nordstroms has migrated
  many of their on-premise and existing cloud infrastructure to serverless
  platforms, which has helped them improve efficiency in both developer time and
  in operational cost.
</p>

<p>
  There are three things that make FaaS platforms like AWS Lambda different from
  other auto-scaling, web infrastructure services:
  <ol>
    <li>
      <strong>Fully-managed operations</strong>: developers using FaaS platforms
      only need to write code that follows the simple request-response software
      pattern. The job of provisioning servers, load-balancing, and fixing
      security vulnerabilities are
      all <span style="font-style:italic">outsourced</span> to the FaaS
      provider. By using these platforms, you are
      essentially <span style="font-style:italic">renting</span> the best
      operations talent on Earth from Amazon, Google, IBM, and Microsoft.
    </li>
    <li>
      <strong>Instantaneous start up and infinite scalability</strong>: for many
      applications, users expect an interactive experience; and delays above a
      few hundred milliseconds can significantly degrade a user's perceived
      quality of the service. In the past, obtaining interactive speeds required
      resources to be over-provisioned so that delays could be minimized even
      under spikes in load; however, having lots of idle servers is both
      expensive and adds complexity to the system. FaaS platforms provide an
      interactive experience without needing to over-provision resources by
      having developers encapsulate their functionality in Linux containers;
      these containers can be started almost instantly and distributed to
      additional nodes in a data center quickly during spikes in load.
    </li>
    <li>
      <strong>Micro-scale billing granularity</strong>: AWS Lambda (and other
      competing services) bill based on invocation time rounded up to the
      nearest 100ms increment, so you only pay for what you use. Cloud VMs and
      container management services provide this same benefit, but with much
      less granularity. For example, EC2 bills a minimum of 1 hour and GCE VMs
      bill a minimum of 10 minutes. As a result, it is frequently much less
      expensive to run a system on a FaaS platform than with cloud VMs or
      on-premise servers where machines may be idle much of the time.
    </li>
  </ol>
</p>

<div class="row" style="padding:10px;border:solid;border-radius:10px;border-width:2px;border-color:rgb(200,200,200);margin:5px;margin-bottom:10px;">
  <div class="col-md-12" style="padding:5px;text-align:center;font-size:15pt;">
    Let's find George Porter (<a href="https://cseweb.ucsd.edu/~gmporter/">
      <img src="/images/awslambdaface/blog_john_emmons_george_porter.jpg" alt="george_porter" style="width:100%;max-width:40px;border-radius:100px;">
    </a>) with AWS Lambda! (<a href="https://github.com/excamera/AWSLambdaFace">code</a>)
  </div>

  <div class="col-md-6" style="padding-top:5px;">
    NSDI'17 full day
    <video style="width: 100%;" controls autoplay muted loop>
      <source src="https://s3-us-west-2.amazonaws.com/blog-john-emmons-assets/awslambdaface/blog_john_emmons_nsdi.mp4" type="video/mp4" />
      The 'video' tag is not supported by your browser.
    </video>
  </div>
    
  <div class="col-md-6" style="padding-top:5px;">
    George Porter montage
    <video style="width: 100%;" controls autoplay muted loop>
      <source src="https://s3-us-west-2.amazonaws.com/blog-john-emmons-assets/awslambdaface/blog_john_emmons_montage.webm" type="video/webm" />
      The 'video' tag is not supported by your browser.
    </video>
  </div>

  <div class="col-md-12">
    Figure 2: The left panel shows six hours of video I recorded while walking
    around with a
    GoPro <a href="/images/awslambdaface/john_emmons_nsdi17.jpg">strapped to my
    head</a> at this
    year's <a href="https://www.usenix.org/conference/nsdi17">USENIX NSDI</a>
    conference. Once the video was recorded, I used a variant
    of <a href="https://cmusatyalab.github.io/openface/">openface</a>, a deep
    neural network based face recognition tool, which I had deployed onto AWS
    Lambda to search for one of the conference
    attendees, <a href="https://cseweb.ucsd.edu/~gmporter/">George
    Porter</a>. Because I had deployed this system on AWS Lambda, the system was
    able to start up 3000+ Lambda workers almost instantly, allowing it to scan
    over all the frames in the video in just a few minutes. Once all of the
    frames where George was present were identified,
    the <a href="http://ex.camera">ExCamera</a> system (which also runs on AWS
    Lambda) was used to stitch together a montage. 
  </div>
</div>

<p>
  The benefits of AWS Lambda make it perfect for web microservices, but these
  same benefits also make it a great tool for other workloads. In fact, it is
  easy to imagine taking any bursty, highly parallelizeable application and
  deploying it on a FaaS platform; and in doing so, that application would gain
  all of the advantages of these services. To demonstrate this, the remainder of
  this blog post is dedicated to explaining how I used AWS Lambda to perform
  massively parallel face recognition using a deep convolutional nueral
  network.
</p>

<p>
  In left panel of figure 2, you see a six hour long video I recorded with a
  GoPro (<a href="/images/awslambdaface/john_emmons_nsdi17.jpg">strapped to my
  head!</a>) from <a href="https://www.usenix.org/conference/nsdi17">USENIX
  NSDI'17</a>, a computer systems and networking conference. I was at the
  conference with <a href="https://cs.stanford.edu/~keithw/">Keith Winstein</a>
  and <a href="http://sadjad.org/">Sadjad Fouladi</a> to help
  present <a href="http://ex.camera">ExCamera</a> and I wanted to record every
  minute of the conference! After recording this video, our goal was to scan
  over the faces in the video and stitch together a montage of all of the times
  I encountered our UCSD
  collaborator, <a href="https://cseweb.ucsd.edu/~gmporter/">George Porter</a>
  (right panel of figure 2); we wanted to make sure he made it to the conference
  safely! And most importantly, we wanted to do all of this on AWS Lambda so
  that thousands of instances of our deep nueral network based face recognizer
  could (1) run in parallel across the video, (2) be billed at a 100ms
  granularity, and (3) start up instantly after invocation.
</p>

<p>
  To perform the face recognition and stitch the montage together, our system
  performs the following steps (see
  the <a href="https://github.com/excamera/AWSLambdaFace">AWSLambdaFace</a>
  github page for more details and simplified demo you can try at home!):
  <ol>
    <li>Upload image with face of interest to an EC2 coordination server and perform standard <a href="https://blog.keras.io/building-powerful-image-classification-models-using-very-little-data.html">image augmentation</a> techniques to generate a training set.</li>
    <li>Use a deep neural network (DNN) to locate and generate 128-dimensional feature vectors for the face in each augmented image in the training set.</li>
    <li>Train a KNN classifier with (1) the augmented image feature vectors and (2) labeled faces in the wild (<a href="http://vis-www.cs.umass.edu/lfw/">lfw</a>) feature vectors.</li>
    <li>Run the DNN featurizer and KNN classifier in parallel across the entire video using 3000+ AWS lambda workers to perform recognition.</li>
    <li>Aggregate all the frames where the face of interest was recognized.</li>
    <li>Launch <a href="http://ex.camera">ExCamera</a> to encode the frames into a montage!</li>
  </ol>
</p>

<p>
  It is unlikely that the major cloud providers (AWS, Google, IBM, or Microsoft)
  would have predicted that their systems would be used to perform computations
  like deep neural networks. However, I hope that after reading this blog post
  you will agree that virtually any bursty, highly parallelizeable application
  could benefit by using FaaS platforms. It is time that we reexamine the ways
  we build mobile and desktop applications since it is now possible to
  affordably and interactively ask for thousands of cores in the cloud.
</p>
